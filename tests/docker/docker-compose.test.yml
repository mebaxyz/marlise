version: '3.8'

services:
  marlise-test-env:
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile.test-environment
    container_name: marlise-test-environment
    ports:
      # mod-host ports
      - "5555:5555"  # command
      - "5556:5556"  # feedback  
      # modhost-bridge port
      - "6000:6000"  # ZMQ
      # session-manager ports
      - "5718:5718"  # ZMQ RPC
      - "6718:6718"  # ZMQ PUB
      - "7718:7718"  # ZMQ SUB
      # client-interface port
      - "8080:8080"  # HTTP/WebSocket
    volumes:
      # Mount test results
      - ./test-results:/tmp/test-results
      # Mount logs for debugging
      - ./logs:/var/log/marlise
    networks:
      - marlise-test
    environment:
      - JACK_NO_AUDIO_RESERVATION=1
      - JACK_NO_START_SERVER=0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Test runner service
  marlise-test-runner:
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile.test-environment
    container_name: marlise-test-runner
    depends_on:
      marlise-test-env:
        condition: service_healthy
    volumes:
      - .:/app/tests
      - ./test-results:/tmp/test-results
    working_dir: /app/tests
    networks:
      - marlise-test
    environment:
      - MARLISE_TEST_HOST=marlise-test-env
      - MARLISE_TEST_PORT=8080
    command: ["python3", "-m", "pytest", "integration/", "-v", "--tb=short"]
    profiles:
      - test

networks:
  marlise-test:
    driver: bridge